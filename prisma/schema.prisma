generator client {
  provider        = "prisma-client"
  output          = "../lib/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// ─── Auth.js Models ───────────────────────────────────────────

model User {
  id                    String    @id @default(cuid())
  name                  String?
  email                 String    @unique
  emailVerified         DateTime?
  image                 String?
  createdAt             DateTime  @default(now())
  onboardingCompletedAt DateTime?
  lastActiveAt          DateTime?

  accounts              Account[]
  sessions              Session[]
  topicWeights          UserTopicWeight[]
  sourceSubscriptions   UserSourceSubscription[]
  sourceAffinities      UserSourceAffinity[]
  userEmbedding         UserEmbedding?
  impressions           ImpressionEvent[]
  interactions          InteractionEvent[]
  suggestions           FeedSuggestion[]       @relation("SuggestedBy")
  reviewedSuggestions   FeedSuggestion[]       @relation("ReviewedBy")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core Entities ────────────────────────────────────────────

model Topic {
  id        String   @id @default(cuid())
  slug      String   @unique
  label     String
  createdAt DateTime @default(now())

  feedSourceTopics    FeedSourceTopic[]
  userTopicWeights    UserTopicWeight[]
  suggestionTopics    FeedSuggestionTopic[]
}

model FeedSource {
  id              String    @id @default(cuid())
  title           String
  url             String    @unique
  siteUrl         String?
  description     String?
  language        String?
  isPreinstalled  Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastFetchedAt   DateTime?
  lastFetchStatus String?
  etag            String?
  lastModified    String?

  topics          FeedSourceTopic[]
  articles        Article[]
  subscriptions   UserSourceSubscription[]
  affinities      UserSourceAffinity[]
}

model FeedSourceTopic {
  feedSourceId String
  topicId      String
  confidence   Float?  @default(1.0)

  feedSource FeedSource @relation(fields: [feedSourceId], references: [id], onDelete: Cascade)
  topic      Topic      @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([feedSourceId, topicId])
}

model Article {
  id           String   @id @default(cuid())
  feedSourceId String
  title        String
  url          String
  guid         String?
  author       String?
  publishedAt  DateTime
  fetchedAt    DateTime @default(now())
  summary      String?
  content      String?
  createdAt    DateTime @default(now())

  feedSource   FeedSource         @relation(fields: [feedSourceId], references: [id], onDelete: Cascade)
  text         ArticleText?
  embedding    ArticleEmbedding?
  stats        ArticleStats?
  impressions  ImpressionEvent[]
  interactions InteractionEvent[]

  @@unique([feedSourceId, guid])
  @@unique([feedSourceId, url])
  @@index([publishedAt])
}

// ─── User State ───────────────────────────────────────────────

model UserTopicWeight {
  userId    String
  topicId   String
  weight    Float    @default(0)
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([userId, topicId])
}

model UserSourceSubscription {
  userId       String
  feedSourceId String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedSource FeedSource @relation(fields: [feedSourceId], references: [id], onDelete: Cascade)

  @@id([userId, feedSourceId])
}

model UserSourceAffinity {
  userId       String
  feedSourceId String
  weight       Float    @default(0)
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedSource FeedSource @relation(fields: [feedSourceId], references: [id], onDelete: Cascade)

  @@id([userId, feedSourceId])
}

// ─── Embeddings ───────────────────────────────────────────────

model ArticleText {
  articleId     String   @id
  extractedText String
  language      String?
  extractedAt   DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
}

model ArticleEmbedding {
  articleId String                      @id
  embedding Unsupported("vector(1536)")?
  model     String
  createdAt DateTime                    @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
}

model UserEmbedding {
  userId    String   @id
  embedding Float[]
  model     String
  version   Int      @default(1)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Event Logging ────────────────────────────────────────────

model ImpressionEvent {
  id               String   @id @default(cuid())
  userId           String
  articleId        String
  feedRequestId    String
  sessionId        String?
  position         Int
  algorithmVersion String
  candidateSources Json
  shownAt          DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, feedRequestId, articleId])
  @@index([userId, shownAt])
  @@index([articleId])
}

model InteractionEvent {
  id        String          @id @default(cuid())
  userId    String
  articleId String
  type      InteractionType
  value     Int?
  createdAt DateTime        @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([articleId])
}

enum InteractionType {
  OPEN
  DWELL
  LIKE
  DISLIKE
  HIDE
  SAVE
  SUBSCRIBE_SOURCE
  UNSUBSCRIBE_SOURCE
}

// ─── Suggestions ──────────────────────────────────────────────

model FeedSuggestion {
  id                String           @id @default(cuid())
  url               String
  title             String?
  note              String?
  status            SuggestionStatus @default(PENDING)
  suggestedByUserId String?
  createdAt         DateTime         @default(now())
  reviewedByUserId  String?
  reviewedAt        DateTime?
  reviewNote        String?
  parsedMeta        Json?

  suggestedBy User?                 @relation("SuggestedBy", fields: [suggestedByUserId], references: [id])
  reviewedBy  User?                 @relation("ReviewedBy", fields: [reviewedByUserId], references: [id])
  topics      FeedSuggestionTopic[]

  @@unique([url, status])
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

model FeedSuggestionTopic {
  suggestionId String
  topicId      String

  suggestion FeedSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  topic      Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([suggestionId, topicId])
}

// ─── Computed Stats ───────────────────────────────────────────

model ArticleStats {
  articleId    String   @id
  impressions  Int      @default(0)
  opens        Int      @default(0)
  likes        Int      @default(0)
  saves        Int      @default(0)
  ctr          Float?
  qualityScore Float?
  updatedAt    DateTime @updatedAt

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
}
